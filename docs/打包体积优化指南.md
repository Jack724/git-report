# Git-Report 打包体积优化指南

## 📊 当前状态

**打包后体积：** 260-266 MB
**主要占用：** PySide6 Qt 库 (~247 MB，93%)

## 🎯 优化目标

- **安全优化：** 220-230 MB（减少 15-20%）
- **推荐优化：** 200-220 MB（减少 25-30%）⭐
- **激进优化：** 180-200 MB（减少 35%，需测试）

---

## 📦 体积分布分析

### 1. PySide6 Qt 库：247 MB (93%)

| 组件 | 大小 | 状态 | 说明 |
|------|------|------|------|
| opengl32sw.dll | 20 MB | ⚠️ 可选删除 | 软件 OpenGL 渲染器 |
| avcodec-61.dll | 14 MB | ⚠️ 可选删除 | 视频编解码器 |
| Qt6Core.dll | 9.7 MB | ✅ 必需 | Qt 核心库 |
| Qt6Gui.dll | 9.1 MB | ✅ 必需 | GUI 库 |
| Qt6Widgets.dll | 6.3 MB | ✅ 必需 | 控件库 |
| Qt6Quick.dll | 6.2 MB | ✅ 必需 | QML 运行时 |
| Qt6Qml.dll | 5.1 MB | ✅ 必需 | QML 引擎 |
| QML 模块 | 22 MB | ⚙️ 部分可删 | 主题、虚拟键盘等 |
| 插件目录 | 7.7 MB | ⚙️ 部分可删 | 图片格式、平台等 |
| 其他 Qt DLL | ~140 MB | ✅ 已优化 | 已排除大量模块 |

### 2. Python 运行时：4.4 MB (2%)
- python39.dll：4.4 MB（必需）

### 3. 加密库（HTTPS）：4.8 MB (2%)
- libcrypto-1_1-x64.dll：4.0 MB（必需，用于 API 调用）
- libssl-1_1-x64.dll：824 KB（必需）

### 4. 应用代码：<1 MB (<1%)

---

## ✅ 已实施的优化

以下模块已通过 `.spec` 文件和 hooks 成功排除：

| 模块 | 节省空间 | 状态 |
|------|---------|------|
| QtWebEngine | ~193 MB | ✅ 已排除 |
| Qt3D 系列 | ~14 MB | ✅ 已排除 |
| QtDesigner | ~11 MB | ✅ 已排除 |
| QtPdf | ~5 MB | ✅ 已排除 |
| QtCharts | ~2 MB | ✅ 已排除 |
| QtMultimedia | ~1 MB | ✅ 已排除 |
| 15+ 其他模块 | ~20 MB | ✅ 已排除 |

**总计已优化：** ~246 MB

---

## 🚀 优化方案

### 方案一：安全优化（推荐）⭐

**预期效果：** 200-220 MB（减少 25-30%）
**风险等级：** 低
**兼容性：** 高

#### 步骤 1：安装 UPX 压缩工具

UPX 可以压缩 DLL 文件，减少 30-50 MB。

```bash
# 下载 UPX
# 访问 https://github.com/upx/upx/releases
# 下载最新版 upx-*-win64.zip

# 解压后将 upx.exe 添加到系统 PATH
# 或复制到项目根目录
```

验证安装：
```bash
upx --version
```

#### 步骤 2：运行增强版清理脚本

项目中的 `cleanup_dist.py` 已增强，会自动删除：

- QML 虚拟键盘（4.8 MB）
- 未使用的 QML 主题（2.5 MB）
- 未使用的插件（2 MB）

正常打包流程：
```bash
# 1. 打包
build.bat

# 2. 清理（已集成在 build.bat 中）
python cleanup_dist.py
```

**预期减少：** 9-10 MB（不含 UPX）
**UPX 额外减少：** 30-50 MB

---

### 方案二：激进优化（需测试）

**预期效果：** 180-200 MB（减少 35%）
**风险等级：** 中
**兼容性：** 需在目标系统测试

#### 额外删除内容：

1. **软件 OpenGL 渲染器（20 MB）**
   - 文件：`opengl32sw.dll`
   - 风险：在没有 GPU 驱动的老系统/虚拟机上可能无法运行
   - 建议：如果目标用户使用 Win10+ 现代系统，可以删除

2. **视频编解码器（16 MB）**
   - 文件：`avcodec-61.dll`、`avformat-61.dll` 等
   - 风险：如果代码中有视频播放功能会失败
   - 建议：应用不播放视频时可以安全删除

3. **不常用图片格式（1 MB）**
   - 文件：WebP、TIFF、TGA 等格式插件
   - 风险：这些格式的图片无法显示
   - 建议：只使用 PNG/JPG 时可以删除

#### 使用方法：

```bash
# 1. 先运行正常打包和基础清理
build.bat

# 2. 测试应用是否正常运行
dist\GitReport\GitReport.exe

# 3. 如果正常，运行激进优化
python cleanup_dist_aggressive.py

# 4. 再次测试所有功能
dist\GitReport\GitReport.exe
```

---

## 📝 详细操作步骤

### 一、安装 UPX（一次性设置）

1. 访问 https://github.com/upx/upx/releases
2. 下载 `upx-*-win64.zip`
3. 解压到任意目录（例如 `C:\Tools\upx`）
4. 将 UPX 目录添加到系统 PATH：
   - 右键"此电脑" → 属性 → 高级系统设置
   - 环境变量 → 系统变量 → Path → 编辑 → 新建
   - 添加 UPX 解压目录路径
   - 确定并重启终端

5. 验证：
   ```bash
   upx --version
   ```

### 二、正常打包流程

```bash
# 安装依赖（首次）
uv sync

# 打包（自动包含清理）
build.bat

# 查看结果
dir dist\GitReport
```

`build.bat` 已自动集成清理流程：
1. PyInstaller 打包
2. 运行 `cleanup_dist.py`
3. 显示最终大小

### 三、可选激进优化

⚠️ **仅在测试通过后使用**

```bash
# 1. 先测试基础版本
dist\GitReport\GitReport.exe

# 2. 如果正常，运行激进清理
python cleanup_dist_aggressive.py
# 输入 yes 确认

# 3. 立即测试所有功能
dist\GitReport\GitReport.exe
```

---

## 🧪 测试检查清单

打包后必须测试以下功能：

- [ ] 应用启动正常
- [ ] 主窗口显示正常
- [ ] 添加/扫描 Git 仓库
- [ ] 选择日期范围
- [ ] 拉取提交记录
- [ ] 查看提交列表
- [ ] 生成 AI 报告
- [ ] 导出报告（Markdown/HTML）
- [ ] 主题切换（亮色/暗色）
- [ ] 配置 AI 服务
- [ ] 所有对话框正常打开
- [ ] 图标显示正常

如果激进优化后出现问题，需要重新打包。

---

## 📊 优化效果对比

| 方案 | 体积 | 减少 | UPX | 风险 | 推荐 |
|------|------|------|-----|------|------|
| 当前版本 | 266 MB | - | ❌ | - | - |
| 当前版本 + UPX | 220-230 MB | 15-20% | ✅ | 低 | ⭐⭐ |
| 安全优化 | 210-220 MB | 20-25% | ❌ | 低 | ⭐⭐⭐ |
| 安全优化 + UPX | 180-200 MB | 30-35% | ✅ | 低 | ⭐⭐⭐⭐⭐ |
| 激进优化 | 195-205 MB | 25-30% | ❌ | 中 | ⭐⭐⭐ |
| 激进优化 + UPX | 170-185 MB | 35-40% | ✅ | 中 | ⭐⭐⭐⭐ |

---

## 🤔 常见问题

### Q1: 为什么 PySide6 这么大？

A: PySide6 是完整的 Qt 框架绑定，包含：
- 跨平台 GUI 库
- QML/Qt Quick 现代 UI 框架
- 硬件加速图形渲染
- 完整的控件和主题系统

使用 qfluentwidgets 需要 Qt Quick，进一步增加了体积。

### Q2: 能不能换成更小的 GUI 框架？

A: 可以，但有权衡：

| 框架 | 体积 | 外观 | 功能 |
|------|------|------|------|
| tkinter | 30-50 MB | ⭐⭐ | ⭐⭐⭐ |
| PyQt5 | 100-150 MB | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| PySide6 | 150-300 MB | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Electron | 100-200 MB | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

目前的 Fluent Design 现代化界面需要 PySide6。

### Q3: UPX 压缩安全吗？

A: 完全安全。UPX 是业界标准的可执行文件压缩工具：
- 开源且广泛使用
- 不修改程序逻辑
- 运行时自动解压
- 被杀毒软件信任

某些杀软可能误报，可以添加信任。

### Q4: 删除 opengl32sw.dll 后无法运行怎么办？

A: 该文件是软件 OpenGL 渲染器，用于没有 GPU 驱动的系统：
- **解决方案 1：** 重新打包（不删除此文件）
- **解决方案 2：** 安装显卡驱动
- **解决方案 3：** 在虚拟机中启用 3D 加速

建议只在现代系统（Win10+）上删除。

### Q5: 260MB 正常吗？

A: 完全正常。对比：
- **PySide6 应用：** 通常 150-400 MB
- **PyQt6 应用：** 通常 120-250 MB
- **Electron 应用：** 通常 100-200 MB
  - VS Code: ~200 MB
  - Discord: ~150 MB
  - Slack: ~180 MB
- **本项目：** 266 MB（带 Fluent Design）

在现代存储环境下（TB 级硬盘）是可接受的。

---

## 🎯 最佳实践建议

### 推荐配置（平衡体积与兼容性）

1. ✅ 安装 UPX
2. ✅ 使用增强版 cleanup_dist.py（已自动集成）
3. ⚠️ 不使用激进优化（除非目标系统明确）
4. ✅ 在目标系统上测试

**预期体积：** 180-200 MB
**兼容性：** 高
**维护成本：** 低

### 面向现代系统（Win10+）

如果确定用户都使用现代系统：

1. ✅ 安装 UPX
2. ✅ 使用增强版 cleanup_dist.py
3. ✅ 使用激进优化删除 opengl32sw.dll
4. ✅ 删除视频编解码器（如果不播放视频）

**预期体积：** 160-180 MB
**兼容性：** 中（需现代系统）
**维护成本：** 中

---

## 📚 参考资源

- [UPX 官网](https://upx.github.io/)
- [PyInstaller 文档](https://pyinstaller.org/)
- [PySide6 文档](https://doc.qt.io/qtforpython/)
- [qfluentwidgets 文档](https://qfluentwidgets.com/)

---

## 📞 遇到问题？

如果遇到打包或优化问题：

1. 查看 `build.bat` 输出日志
2. 检查 `dist/GitReport` 目录结构
3. 运行 `python cleanup_dist.py` 查看删除日志
4. 在目标系统测试应用功能

---

**最后更新：** 2025-11-10
**版本：** 1.0
